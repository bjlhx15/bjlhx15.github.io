<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://blog.bjlhx.top').hostname,
    root: '/',
    scheme: 'Pisces',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":{"utteranc":{"text":"评论[utteranc,基于github]","order":-2},"livere":{"text":"评论[来必力,三方]","order":-1}}},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="摘要：InnoDB表空间文件.ibd文件内部存储单元是页，初始大小为 96K，而InnoDB默认页大小为 16K。当然页大小也可以通过 innodb_page_size 配置为 4K, 8K…64K 等。 如果用二进制打开，以16K划分一页。在ibd文件中，0-16KB偏移量即为0号数据页，16KB-32KB的为1号数据页，以此类推。">
<meta property="og:type" content="article">
<meta property="og:title" content="06-存储引擎层-innodb框架-表空间-段、区、页与组织结构">
<meta property="og:url" content="https://blog.bjlhx.top/articles/20200202/12fe7f8a.html">
<meta property="og:site_name" content="Blog">
<meta property="og:description" content="摘要：InnoDB表空间文件.ibd文件内部存储单元是页，初始大小为 96K，而InnoDB默认页大小为 16K。当然页大小也可以通过 innodb_page_size 配置为 4K, 8K…64K 等。 如果用二进制打开，以16K划分一页。在ibd文件中，0-16KB偏移量即为0号数据页，16KB-32KB的为1号数据页，以此类推。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.bjlhx.top/images/post/db-mysql/006/tablespace.webp">
<meta property="og:image" content="https://blog.bjlhx.top/images/post/db-mysql/001/mysql-disk.jpg">
<meta property="og:image" content="https://blog.bjlhx.top/images/post/db-mysql/001/file-0k.jpg">
<meta property="og:image" content="https://blog.bjlhx.top/images/post/db-mysql/001/file-1k.jpg">
<meta property="og:image" content="https://blog.bjlhx.top/images/post/db-mysql/page-struct.jpg">
<meta property="og:image" content="https://blog.bjlhx.top/images/post/db-mysql/insupermum.jpg">
<meta property="og:image" content="https://blog.bjlhx.top/images/post/db-mysql/index-page-extents1.jpg">
<meta property="og:image" content="https://blog.bjlhx.top/images/post/db-mysql/ibdfile.webp">
<meta property="og:image" content="https://blog.bjlhx.top/images/post/db-mysql/index-page-extents2.png">
<meta property="og:image" content="https://blog.bjlhx.top/images/post/db-mysql/index-struct.webp">
<meta property="og:image" content="https://blog.bjlhx.top/images/post/db-mysql/fseg.webp">
<meta property="og:image" content="https://blog.bjlhx.top/images/post/db-mysql/bptreepagestruct.webp">
<meta property="article:published_time" content="2020-02-02T01:30:07.000Z">
<meta property="article:modified_time" content="2020-02-05T08:57:25.610Z">
<meta property="article:author" content="李宏旭">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.bjlhx.top/images/post/db-mysql/006/tablespace.webp">

<link rel="canonical" href="https://blog.bjlhx.top/articles/20200202/12fe7f8a.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>06-存储引擎层-innodb框架-表空间-段、区、页与组织结构 | Blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2369ef7686f6340d44efd18b5d7e7b3e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">个人博客</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">4</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">8</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">32</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/bjlhx15" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.bjlhx.top/articles/20200202/12fe7f8a.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/about/kenan.jpeg">
      <meta itemprop="name" content="李宏旭">
      <meta itemprop="description" content="学习 总结 分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          06-存储引擎层-innodb框架-表空间-段、区、页与组织结构
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-02 09:30:07" itemprop="dateCreated datePublished" datetime="2020-02-02T09:30:07+08:00">2020-02-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-02-05 16:57:25" itemprop="dateModified" datetime="2020-02-05T16:57:25+08:00">2020-02-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/db-mysql-core/" itemprop="url" rel="index">
                    <span itemprop="name">db-mysql-core</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>摘要：InnoDB表空间文件.ibd文件内部存储单元是页，初始大小为 96K，而InnoDB默认页大小为 16K。当然页大小也可以通过 innodb_page_size 配置为 4K, 8K…64K 等。</p>
<p>如果用二进制打开，以16K划分一页。在ibd文件中，0-16KB偏移量即为0号数据页，16KB-32KB的为1号数据页，以此类推。</p>
<a id="more"></a>

<h1 id="表空间物理结构-页、区、段"><a href="#表空间物理结构-页、区、段" class="headerlink" title="表空间物理结构-页、区、段"></a>表空间物理结构-页、区、段</h1><p>磁盘最小单位是512字节，操作系统是4KB，mysql里最小的是page（页面）有16K。</p>
<p>ibd就是放索引树的，但总不能一个树就摊在一个txt文档里，所以必须还要有一种文件组织结构。所有的数据都放在page里，用一种规则来把N个page连一起，让它们形成一些关联，才能便于查询，要先找到page，再找到page内的数据。</p>
<p>B+树是离不开页面page</p>
<p><img src="/images/post/db-mysql/006/tablespace.webp" alt=""></p>
<h2 id="段（segment）"><a href="#段（segment）" class="headerlink" title="段（segment）"></a>段（segment）</h2><p>段是表空间文件中的主要组织结构，它是一个逻辑概念，用来管理物理文件，是构成索引、表、回滚段的基本元素。</p>
<p>表空间是由各个段组成的，常见的段有数据段、索引段、回滚段等。</p>
<p>InnoDB存储引擎表是索引组织的（index organized），因此数据即索引，索引即数据。那么数据段即为B+树的页节点（上图的leaf node segment），索引段即为B+树的非索引节点（上图的non-leaf node segment）。</p>
<p>创建一个索引（B+树）时会同时创建两个段，分别是内节点段和叶子段，内节点段用来管理（存储）B+树非叶子（页面）的数据（分裂、增长、删除等），叶子段用来管理（存储）B+树叶子节点的数据，负责行数据的相关动作；</p>
<p>也就是说，在索引数据量一直增长的过程中，所有新的存储空间的申请，都是从“段”这个概念中申请的。一个段包含256个区(256M大小)。</p>
<h2 id="区-簇（extents）"><a href="#区-簇（extents）" class="headerlink" title="区/簇（extents）"></a>区/簇（extents）</h2><p>段是个逻辑概念，innodb引入了簇的概念，在代码中被称为extent；</p>
<p>簇是由64个连续的页组成的，每个页大小为16KB，即每个簇的大小为1MB硬盘空间。即默认大小为 1MB (64*16K)。</p>
<p>簇是构成段的基本元素，一个段由若干个簇构成。一个簇是物理上连续分配的一个段空间，每一个段至少会有一个簇，在创建一个段时会创建一个默认的簇。</p>
<p>如果存储数据时，即往段里写入数据，就是往簇里写数据，簇是硬盘空间，当一个簇已经不足以放下更多的数据，此时需要从这个段中分配一个新的簇来存放新的数据，等于又多了一块64*16K的连续硬盘空间。</p>
<p>一个段所管理的空间大小是无限的，可一直扩展下去，但是扩展的最小单位就是簇。注意，每个簇是一块连续的硬盘空间，但多个簇之间可不是连续的。</p>
<p>同样，两个段之间，在硬盘上也没有什么关系。</p>
<h2 id="页（page）"><a href="#页（page）" class="headerlink" title="页（page）"></a>页（page）</h2><h3 id="页存储单元"><a href="#页存储单元" class="headerlink" title="页存储单元"></a>页存储单元</h3><p>磁盘扇区、文件系统、InnoDB 存储引擎都有各自的最小存储单元。存储数据的最小单位。</p>
<p><img src="/images/post/db-mysql/001/mysql-disk.jpg" alt=""></p>
<ul>
<li><p>磁盘扇区存储单元-扇区-512字节<br>在计算机中磁盘存储数据最小单元是扇区，一个扇区的大小是 512 字节</p>
</li>
<li><p>文件系统存储单元-块-4k<br>文件系统(例如 XFS/EXT4)他的最小单元是块，一个块的大小是 4K。<br>文件系统中一个文件大小只有 1 个字节，但不得不占磁盘上 4KB 的空间。[0k不占空间]<br><img src="/images/post/db-mysql/001/file-0k.jpg" alt="">  <img src="/images/post/db-mysql/001/file-1k.jpg" alt=""></p>
</li>
<li><p>InnoDB存储单元-页-16k<br>InnoDB 存储引擎也有自己的最小储存单元——页(Page)，一个页的大小是 16K。<br>InnoDB 的所有数据文件(后缀为 ibd 的文件)，他的大小始终都是 16384(16K)的整数倍。  </p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ll |grep ibd </span><br><span class="line">-rw…………    96K 10 31 11:22 innodb_index_stats.ibd</span><br><span class="line">-rw…………    96K 10 31 11:22 innodb_table_stats.ibd</span><br><span class="line">-rw…………    96K 10  2  2018 slave_master_info.ibd</span><br><span class="line">-rw…………    96K 10  2  2018 slave_relay_log_info.ibd</span><br><span class="line">-rw…………    96K 10  2  2018 slave_worker_info.ibd</span><br></pre></td></tr></table></figure>

<p>InnoDB有页（page）的概念，可以理解为簇的细化。页是InnoDB磁盘管理的最小单位。</p>
<h3 id="页结构"><a href="#页结构" class="headerlink" title="页结构"></a>页结构</h3><p>所有页的结构都是一样的，分为文件头(前38字节)，页数据和文件尾(后8字节)。页数据根据页的类型不同而不一样。</p>
<p>页的头尾除了一些元信息外，还有Checksum校验值，这些校验值在写入磁盘前计算得到，当从磁盘中读取时，重新计算校验值并与数据页中存储的对比，如果发现不同，则会导致 MySQL 崩溃。</p>
<p><img src="/images/post/db-mysql/page-struct.jpg" alt=""></p>
<h4 id="File-Header-记录页的一些头信息，共占用38字节，组成部分如"><a href="#File-Header-记录页的一些头信息，共占用38字节，组成部分如" class="headerlink" title="File Header 记录页的一些头信息，共占用38字节，组成部分如:"></a>File Header 记录页的一些头信息，共占用38字节，组成部分如:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">名称	大小（Bytes）	描述</span><br><span class="line">FIL_PAGE_SPACE_OR_CHKSUM	4	当mysql4.0.14之前，值是0，之后该值代表页的checksum值</span><br><span class="line">FIL_PAGE_OFFSET	        4	表空间中页的偏移量。。如某独立表空间a.ibd的大小为1GB，如果页的大小为16KB，那么总共有65536个页。</span><br><span class="line">                            FILE_PAGE_OFFSET表示该页在所有页中的位置。若此表空间的ID为10，那么搜索页（10，1）就表示查找表a中的第二页</span><br><span class="line">FIL_PAGE_PREV	        4	该页的上一个页，B+tree特性决定了叶子节点必须是双向列表</span><br><span class="line">FIL_PAGE_NEXT	        4	该页的下一个页，B+tree特性决定了叶子节点必须是双向列表</span><br><span class="line">FIL_PAGE_LSN	        8	该页最后被修改的LSN日志序列位置（Log Sequence Number）</span><br><span class="line">FIL_PAGE_TYPE	        2	该页的类型，0x45BF为数据页,实际行记录的存储空间</span><br><span class="line">FIL_PAGE_FILE_FLUSH_LSN	8	独立表空间中为0，如在系统表空间表示一个页的定义，代表文件至少被更新到了该LSN值</span><br><span class="line">FIL_PAGE_ARCH_LOG_NO	4	从4.1开始，该页属于哪一个表空间</span><br></pre></td></tr></table></figure>

<h5 id="页类型【innodb存储引擎中】"><a href="#页类型【innodb存储引擎中】" class="headerlink" title="页类型【innodb存储引擎中】"></a>页类型【innodb存储引擎中】</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">名称	大小（Bytes）	描述</span><br><span class="line">FIL_PAGE_INDEX          0x45BF  数据页，B+树叶节点，索引页的叶子结点的data就是数据，如聚集索引存储的行数据，辅助索引存储的主键值。</span><br><span class="line">FIL_PAGE_UNDO_LOG	    0x0002  Undo页（Undo Log Page）</span><br><span class="line">FIL_PAGE_INODE	        0x0003  索引节点</span><br><span class="line">FIL_PAGE_IBUF_FREE_LIST 0x0004  插入缓冲空闲列表页（Insert Buffer Free List）</span><br><span class="line">FIL_PAGE_TYPE_ALLOCATED 0x0000  最新分配</span><br><span class="line">FIL_PAGE_IBUF_BITMAP	0x0005  插入缓冲位图页（Insert Buffer Bitmap）。用于记录 change buffer的使用情况。</span><br><span class="line">FIL_PAGE_TYPE_SYS       0x0006  系统页（System Page）</span><br><span class="line">FIL_PAGE_TYPE_TRX_SYS   0x0007  事务数据页（Transaction system Page）</span><br><span class="line">FIL_PAGE_TYPE_FSP_HDR   0x0008  File Space Header，主要用于跟踪表空间，空闲链表、碎片页以及区等信息。</span><br><span class="line">FIL_PAGE_TYPE_XDES      0x0009  扩展描述也</span><br><span class="line">FIL_PAGE_TYPE_BLOB      0x000A  BLOB Page</span><br></pre></td></tr></table></figure>
<ul>
<li><p>FIL_PAGE_INODE：用于记录文件段(FSEG)的信息，每页有85个INODE entry，每个INODE entry占用192字节，用于描述一个文件段。每个INODE entry包括文件段ID、属于该段的区的信息以及碎片页数组。区信息包括 FREE(完全空闲的区), NOT_FULL(至少使用了一个页的区), FULL(没空闲页的区)三种类型的区的List Base Node(包含链表长度和头尾页号和偏移的结构体)。碎片页数组则是不同于分配整个区的单独分配的32个页。</p>
</li>
<li><p>FIL_PAGE_TYPE_FSP_HDR 页：用于存储区的元信息。<br>ibd文件的第一页 FSP_HDR 页通常就用于存储区的元信息，里面的256个 XDES(extent descriptors) 项存储了256个区的元信息，包括区的使用情况和区里面页的使用情况。</p>
<p>更多 参看 附表 </p>
</li>
</ul>
<h4 id="Page-Header：记录数据页的状态信息，共占56个字节，组成部分如图："><a href="#Page-Header：记录数据页的状态信息，共占56个字节，组成部分如图：" class="headerlink" title="Page Header：记录数据页的状态信息，共占56个字节，组成部分如图："></a>Page Header：记录数据页的状态信息，共占56个字节，组成部分如图：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">名称	大小（Bytes）	描述</span><br><span class="line">PAGE_N_DIR_SLOTS	2	在Page Directory中Slot的数量，初始值为2</span><br><span class="line">PAGE_HEAP_TOP	    2	堆中第一个记录的指针,记录在页中是根据堆的形式存放</span><br><span class="line">PAGE_N_HEAP	        2	堆中的记录数，初始值为2，但是第15位表示行记录格式</span><br><span class="line">PAGE_FREE	        2	指向可重用空间的首指针</span><br><span class="line">PAGE_GARBAGE	    2	已标记为删除（deleted_flag）的记录的字节数</span><br><span class="line">PAGE_LAST_INSERT	2	最后插入记录的位置</span><br><span class="line">PAGE_DIRECTION	    2	最后插入的方向，PAGE_LEFT(0x01)，PAGE_RIGHT(0x02)，PAGE_SAME_REC(0X03),PAGE_SAME_PAGE(0X04),PAGE_NO_DIRECTION(0x05)</span><br><span class="line">PAGE_N_DIRECTION	2	一个方向上连续插入记录的数量</span><br><span class="line">PAGE_N_RECS	        2	该页中记录（User Record）的数量</span><br><span class="line">PAGE_MAX_TRX_ID	    8	修改该页的最大事务ID（仅在辅助索引中定义）</span><br><span class="line">PAGE_LEVEL	        2	该页在索引树中位置，0000代表叶子节点</span><br><span class="line">PAGE_INDEX_ID	    8	索引ID，表示该页属于哪个索引</span><br><span class="line">PAGE_BTR_SEG_LEAF	10	B+Tree叶子节点所在Leaf Node Segment的Segment Header（无关紧要）</span><br><span class="line">PAGE_BTR_SEG_TOP	10	B+Tree非叶子节点所在Non-Leaf Node Segment的Segment Header（无关紧要）</span><br></pre></td></tr></table></figure>

<h4 id="infimum和supermum-record"><a href="#infimum和supermum-record" class="headerlink" title="infimum和supermum record"></a>infimum和supermum record</h4><ul>
<li>每个数据页中都有两个虚拟的行记录，用来限定记录（User Record）的边界（Infimum为下界，Supremum为上界）</li>
<li>Infimum和Supremum在页被创建是自动创建，不会被删除</li>
<li>在Compact和Redundant行记录格式下，Infimum和Supremum占用的字节数是不一样的<br><img src="/images/post/db-mysql/insupermum.jpg" alt=""></li>
<li>5.1后有Compact（默认）和Redundant两种格式<ul>
<li>Compact行记录格式<br>设计目标为高效存放数据，行数据越多，性能越高。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">变长字段长度列表    |   NULL标志位     |   记录头信息   |   列1数据    |   列2数据    |   ……  |</span><br></pre></td></tr></table></figure>
<ul>
<li>变长字段长度列表，按照列的顺序逆序放置。列长度小于255字节，用1字节表示，大于255字节，则用2个字节表示</li>
<li>NULL标志位，一个字节，表示对应列为NULL</li>
<li>记录头信息，5个字节，含义见下表</li>
<li>下面即为数据列，NULL不占用存储空间</li>
<li>每行除了用户定义的列，还有两个隐藏列，事务ID列（6字节）和回滚指针列（7字节），若没有定义主键，每行还会有一个6字节的RowID列<figure class="highlight plain"><figcaption><span>Compact行记录格式</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">名称          大小（bit） 描述</span><br><span class="line">（）          1           未知</span><br><span class="line">（）          1           未知</span><br><span class="line">deleted_flag  1         该行是否被删除</span><br><span class="line">min_rec_flag  1         为1，如果该记录是预先被定义为最小的记录</span><br><span class="line">n_owned       4         该记录拥有的记录数</span><br><span class="line">heap_no       13        索引堆中该条记录的排序记录</span><br><span class="line">record_type   3         记录类型 000&#x3D;普通 001&#x3D;B+树节点指针 010-Infimum 011&#x3D;Supremum 1xx&#x3D;保留</span><br><span class="line">next_recorder 16        页中下一条记录的相对位置</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>Redundant行记录格式</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">字段长度偏移列表    |   记录头信息   |   列1数据    |   列2数据    |   ……  |</span><br></pre></td></tr></table></figure>
<ul>
<li>字段长度偏移列表，按照列的顺序逆序放置。列长度小于255字节，用1字节表示，大于255字节，则用2个字节表示</li>
<li>记录头信息，固定占用6个字节，含义见下表。n_fields、1byte_offs_flag两个值值得注意</li>
<li>数据列，varchar的NULL值不占用存储空间，但是char值需要占用空间</li>
</ul>
<figure class="highlight plain"><figcaption><span>Compact行记录格式</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">名称          大小（bit） 描述</span><br><span class="line">（）          1           未知</span><br><span class="line">（）          1           未知</span><br><span class="line">deleted_flag  1         该行是否被删除</span><br><span class="line">min_rec_flag  1         为1，如果该记录是预先被定义为最小的记录</span><br><span class="line">n_owned       4         该记录拥有的记录数</span><br><span class="line">heap_no       13        索引堆中该条记录的排序记录</span><br><span class="line">lbyte_offs_flag 1       偏移列表为1字节还是2字节</span><br><span class="line">next_recorder 16        页中下一条记录的相对位置</span><br></pre></td></tr></table></figure>

<h4 id="User-Records"><a href="#User-Records" class="headerlink" title="User Records"></a>User Records</h4><ul>
<li>存储实际插入的行记录</li>
<li>在Page Header中PAGE_HEAP_TOP、PAGE_N_HEAP的HEAP，实际上指的是Unordered User Record List<ul>
<li>InnoDB不想每次都依据B+Tree键的顺序来插入新行，因为这可能需要移动大量的数据</li>
<li>因此InnoDB插入新行时，通常是插入到当前行的后面（Free Space的顶部）或者是已删除行留下来的空间</li>
</ul>
</li>
<li>为了保证访问B+Tree记录的顺序性，在每个记录中都有一个指向下一条记录的指针，以此构成了一条单向有序链表</li>
</ul>
<h4 id="Free-Space"><a href="#Free-Space" class="headerlink" title="Free Space"></a>Free Space</h4><ul>
<li>空闲空间，数据结构是链表，在一个记录被删除后，该空间会被加入到空闲链表中</li>
</ul>
<h4 id="Page-Directory"><a href="#Page-Directory" class="headerlink" title="Page Directory"></a>Page Directory</h4><ul>
<li>存放着行记录（User Record）的相对位置（不是偏移量）</li>
<li>这里的行记录指针称为Slot或Directory Slot，每个Slot占用2Byte</li>
<li>并不是每一个行记录都有一个Slot，一个Slot中可能包含多条行记录，通过行记录中n_owned字段标识</li>
<li>Infimum的n_owned总是1，Supremum的n_owned为[1,8]，User Record的n_owned为[4,8]</li>
<li>Slot是按照索引键值的顺序进行逆序存放（Infimum是下界，Supremum是上界），可以利用二分查找快速地定位一个粗略的结果，然后再通过next_record进行精确查找</li>
<li>B+Tree索引本身并不能直接找到具体的一行记录，只能找到该行记录所在的页<ul>
<li>数据库把页载入到内存中，然后通过Page Directory再进行二分查找</li>
<li>二分查找时间复杂度很低，又在内存中进行查找，这部分的时间基本开销可以忽略</li>
</ul>
</li>
</ul>
<h4 id="File-Trailer"><a href="#File-Trailer" class="headerlink" title="File Trailer"></a>File Trailer</h4><ul>
<li>总共8 Bytes，为了检测页是否已经完整地写入磁盘</li>
<li>变量innodb_checksums，InnoDB从磁盘读取一个页时是否会检测页的完整性</li>
<li>变量innodb_checksum_algorithm，检验和算法<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">称	大小（Bytes）	描述</span><br><span class="line">FIL_PAGE_END_LSN	8	前4Bytes与File Header中的FIL_PAGE_SPACE一致，后4Bytes与File Header中的FIL_PAGE_LSN的后4Bytes一致</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE 'innodb_checksums';</span><br><span class="line">+<span class="comment">------------------+-------+</span></span><br><span class="line">| Variable_name    | Value |</span><br><span class="line">+<span class="comment">------------------+-------+</span></span><br><span class="line">| innodb_checksums | ON    |</span><br><span class="line">+<span class="comment">------------------+-------+</span></span><br><span class="line">row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line">mysql&gt; <span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'innodb_checksum_algorithm'</span>;</span><br><span class="line">+<span class="comment">---------------------------+-------+</span></span><br><span class="line">| Variable_name             | Value |</span><br><span class="line">+<span class="comment">---------------------------+-------+</span></span><br><span class="line">| innodb_checksum_algorithm | crc32 |</span><br><span class="line">+<span class="comment">---------------------------+-------+</span></span><br><span class="line">row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p><img src="/images/post/db-mysql/index-page-extents1.jpg" alt=""></p>
<ol>
<li><p>每个簇里有64个页面，都会进行编号，页面就是最小的存储单元了。在逻辑上（页面号都是从小到大连续的）及物理上都是连续的。</p>
</li>
<li><p>在向表中插入数据时，如果一个页面已经被写完，系统会从当前簇中分配一个新的空闲页面处理使用，如果当前簇中的64个页面都被分配完，系统会从当前页面所在段中分配一个新的簇，然后再从这个簇中分配一个新的页面来使用；</p>
<ul>
<li>一个页面16K，放主键如int型能放几千，放一行数据，如1K一行，能放十几行。</li>
<li>这里需要注意，一行数据尽量不要过大，一旦跨page，就会对性能产生影响。本来一个page就能查出来，结果每次要查2个page，那性能就丢了一倍。</li>
</ul>
</li>
</ol>
<figure class="highlight plain"><figcaption><span>官网</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Pages, Extents, Segments, and Tablespaces</span><br><span class="line"></span><br><span class="line">Each tablespace consists of database pages. Every tablespace in a MySQL instance has the same page size. By default, all tablespaces have a page size of 16KB; you can reduce the page size to 8KB or 4KB by specifying the innodb_page_size option when you create the MySQL instance. You can also increase the page size to 32KB or 64KB. For more information, refer to the innodb_page_sizedocumentation.</span><br><span class="line"></span><br><span class="line">The pages are grouped into extents of size 1MB for pages up to 16KB in size (64 consecutive 16KB pages, or 128 8KB pages, or 256 4KB pages). For a page size of 32KB, extent size is 2MB. For page size of 64KB, extent size is 4MB. The “files” inside a tablespace are called segments in InnoDB. (These segments are different from the rollback segment, which actually contains many tablespace segments.)</span><br><span class="line"></span><br><span class="line">When a segment grows inside the tablespace, InnoDB allocates the first 32 pages to it one at a time. After that, InnoDB starts to allocate whole extents to the segment. InnoDB can add up to 4 extents at a time to a large segment to ensure good sequentiality of data.</span><br><span class="line"></span><br><span class="line">Two segments are allocated for each index in InnoDB. One is for nonleaf nodes of the B-tree, the other is for the leaf nodes. Keeping the leaf nodes contiguous on disk enables better sequential I&#x2F;O operations, because these leaf nodes contain the actual table data.</span><br><span class="line"></span><br><span class="line">Some pages in the tablespace contain bitmaps of other pages, and therefore a few extents in an InnoDB tablespace cannot be allocated to segments as a whole, but only as individual pages.</span><br></pre></td></tr></table></figure>

<h1 id="表空间ibd与页关系"><a href="#表空间ibd与页关系" class="headerlink" title="表空间ibd与页关系"></a>表空间ibd与页关系</h1><p>一个表，占用一个表空间，创建一个表空间时，至少有一个文件（0号文件），这个文件的第一个页面page，page_no=0，这个page中存储了这个表空间中，所有段、簇、页管理的入口。</p>
<p>InnoDB表空间文件.ibd文件内部存储单元是页，初始大小为 96K，而InnoDB默认页大小为 16K。当然页大小也可以通过 innodb_page_size 配置为 4K, 8K…64K 等。</p>
<p>如果用二进制打开，以16K划分一页。在ibd文件中，0-16KB偏移量即为0号数据页，16KB-32KB的为1号数据页，以此类推。</p>
<h2 id="ibd文件存储结构【页】"><a href="#ibd文件存储结构【页】" class="headerlink" title="ibd文件存储结构【页】"></a>ibd文件存储结构【页】</h2><ol>
<li>图形<br><img src="/images/post/db-mysql/ibdfile.webp" alt=""><br>更为抽象一点的<br><img src="/images/post/db-mysql/index-page-extents2.png" alt=""></li>
<li>sql查询<br>可以在 innodb_sys_tables 表中查到表t的表空间ID为 36，然后可以在 innodb_buffer_page查到所有页信息，一共4个页。<br>分别是 FSP_HDR, IBUF_BITMAP, INODE, INDEX。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_SYS_TABLES <span class="keyword">WHERE</span> <span class="keyword">NAME</span>=<span class="string">'test_innodb/table15w'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> information_schema.innodb_buffer_page <span class="keyword">where</span> <span class="keyword">SPACE</span>=<span class="number">36</span>;</span><br></pre></td></tr></table></figure></li>
<li>实际文件结构：</li>
</ol>
<ul>
<li>第0页是 FSP_HDR 页，主要用于跟踪表空间，空闲链表、碎片页以及区等信息。</li>
<li>第1页是 IBUF_BITMAP 页，保存Change Buffer的位图。</li>
<li>第2页是 INODE 页，用于存储区和单独分配的碎片页信息，包括FULL、FREE、NOT_FULL 等页列表的基础结点信息(基础结点信息记录了列表的起始和结束页号和偏移等)，这些结点指向的是 FSP_HDR 页中的项，用于记录页的使用情况，它们之间关系如下图所示。</li>
<li>第3页开始是索引页 INDEX(B-tree node)，从 0xc000(每页16K) 开始，后面还有些分配的未使用的页。</li>
</ul>
<h1 id="表空间文件ibd-页类型-实操说明"><a href="#表空间文件ibd-页类型-实操说明" class="headerlink" title="表空间文件ibd-页类型-实操说明"></a>表空间文件ibd-页类型-实操说明</h1><h2 id="FSP-HDR-PAGE【File-Space-Header-Page】"><a href="#FSP-HDR-PAGE【File-Space-Header-Page】" class="headerlink" title="FSP_HDR PAGE【File Space Header Page】"></a>FSP_HDR PAGE【File Space Header Page】</h2><p>数据文件.ibd的第一个Page类型为FIL_PAGE_TYPE_FSP_HDR，在创建一个新的表空间时进行初始化(fsp_header_init)，</p>
<p>该page同时用于跟踪随后的256个Extent(约256MB文件大小)的空间管理，所以每隔256MB就要创建一个类似的数据页，类型为FIL_PAGE_TYPE_XDES ，XDES Page除了文件头部外，</p>
<p>其他都和FSP_HDR页具有相同的数据结构，可以称之为Extent描述页，每个Extent占用40个字节，一个XDES Page最多描述256个Extent。</p>
<p>FSP_HDR页的头部使用FSP_HEADER_SIZE个字节来记录文件的相关信息，具体的包括：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Macro	bytes	Desc</span><br><span class="line">FSP_SPACE_ID	4	该文件对应的space id</span><br><span class="line">FSP_NOT_USED	4	如其名，保留字节，当前未使用</span><br><span class="line">FSP_SIZE	4	当前表空间总的PAGE个数，扩展文件时需要更新该值（fsp_try_extend_data_file_with_pages）</span><br><span class="line">FSP_FREE_LIMIT	4	当前尚未初始化的最小Page No。从该Page往后的都尚未加入到表空间的FREE LIST上。</span><br><span class="line">FSP_SPACE_FLAGS	4	当前表空间的FLAG信息，见下文</span><br><span class="line">FSP_FRAG_N_USED	4	FSP_FREE_FRAG链表上已被使用的Page数，用于快速计算该链表上可用空闲Page数</span><br><span class="line">FSP_FREE	16	当一个Extent中所有page都未被使用时，放到该链表上，可以用于随后的分配</span><br><span class="line">FSP_FREE_FRAG	16	FREE_FRAG链表的Base Node，通常这样的Extent中的Page可能归属于不同的segment，用于segment frag array page的分配（见下文）</span><br><span class="line">FSP_FULL_FRAG	16	Extent中所有的page都被使用掉时，会放到该链表上，当有Page从该Extent释放时，则移回FREE_FRAG链表</span><br><span class="line">FSP_SEG_ID	8	当前文件中最大Segment ID + 1，用于段分配时的seg id计数器</span><br><span class="line">FSP_SEG_INODES_FULL	16	已被完全用满的Inode Page链表</span><br><span class="line">FSP_SEG_INODES_FREE	16	至少存在一个空闲Inode Entry的Inode Page被放到该链表上</span><br></pre></td></tr></table></figure>
<p>第一页的 前38字节</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C  -n 38 table5hang.ibd</span><br><span class="line">00000000  ff 64 a5 b7 00 00 00 00  00 00 00 00 00 00 00 00  |.d..............|</span><br><span class="line">00000010  00 00 00 00 80 eb 9d 23  00 08 00 00 00 00 00 00  |.......<span class="comment">#........|</span></span><br><span class="line">00000020  00 00 00 00 00 2c                                 |.....,|</span><br><span class="line">00000026</span><br><span class="line">(base)</span><br></pre></td></tr></table></figure>

<p>通过 ：File Header 记录页的一些头信息 参看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">名称	大小（Bytes）	描述</span><br><span class="line">FIL_PAGE_SPACE_OR_CHKSUM	4	ff 64 a5 b7：checksum值</span><br><span class="line">FIL_PAGE_OFFSET	        4	00 00 00 00：表空间中页的偏移量</span><br><span class="line">FIL_PAGE_PREV	        4	00 00 00 00：该页的上一个页</span><br><span class="line">FIL_PAGE_NEXT	        4	00 00 00 00：该页的下一个页，B+tree特性决定了叶子节点必须是双向列表</span><br><span class="line">FIL_PAGE_LSN	        8	00 00 00 00 80 eb 9d 23：该页最后被修改的LSN日志序列位置（Log Sequence Number）</span><br><span class="line">FIL_PAGE_TYPE	        2	00 08：&#x3D; FSP_HDR 该页的类型，</span><br><span class="line">FIL_PAGE_FILE_FLUSH_LSN	8	00 00 00 00 00 00 00 00 ：独立表空间中为0</span><br><span class="line">FIL_PAGE_ARCH_LOG_NO	4	00 00 00 2c：&#x3D;2*16+12&#x3D;44 该页属于哪一个表空间，与上文sql 查询一致</span><br></pre></td></tr></table></figure>

<h2 id="IBUF-BITMAP-Page"><a href="#IBUF-BITMAP-Page" class="headerlink" title="IBUF_BITMAP Page"></a>IBUF_BITMAP Page</h2><p>第2个page类型为FIL_PAGE_IBUF_BITMAP，主要用于跟踪随后的每个page的change buffer信息，使用4个bit来描述每个page的change buffer信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Macro	bits	Desc</span><br><span class="line">IBUF_BITMAP_FREE	2	使用2个bit来描述page的空闲空间范围：0（0 bytes）、1（512 bytes）、2（1024 bytes）、3（2048 bytes）</span><br><span class="line">IBUF_BITMAP_BUFFERED	1	是否有ibuf操作缓存</span><br><span class="line">IBUF_BITMAP_IBUF	1	该Page本身是否是Ibuf Btree的节点</span><br></pre></td></tr></table></figure>
<p>由于bitmap page的空间有限，同样每隔256个Extent Page之后，也会在XDES PAGE之后创建一个ibuf bitmap page。</p>
<p>offsets:16<em>1024</em>1=16384</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C -s 16384 -n 38 table5hang.ibd</span><br><span class="line">00004000  a0 58 07 7e 00 00 00 01  00 00 00 00 00 00 00 00  |.X.~............|</span><br><span class="line">00004010  00 00 00 00 80 eb 93 80  00 05 00 00 00 00 00 00  |................|</span><br><span class="line">00004020  00 00 00 00 00 2c                                 |.....,|</span><br><span class="line">00004026</span><br><span class="line">(base)</span><br></pre></td></tr></table></figure>
<p>前 38也是  File Header<br>00 05 : FIL_PAGE_IBUF_BITMAP    0x0005  插入缓冲位图页（Insert Buffer Bitmap）。用于记录 change buffer的使用情况。 </p>
<h2 id="FIL-PAGE-INODE"><a href="#FIL-PAGE-INODE" class="headerlink" title="FIL_PAGE_INODE"></a>FIL_PAGE_INODE</h2><p>数据文件的第3个page的类型为FIL_PAGE_INODE，用于管理数据文件中的segement，每个索引占用2个segment，分别用于管理叶子节点和非叶子节点。</p>
<p>每个inode页可以存储FSP_SEG_INODES_PER_PAGE（默认为85）个记录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Macro	bits	Desc</span><br><span class="line">FSEG_INODE_PAGE_NODE	12	INODE页的链表节点，记录前后Inode Page的位置，BaseNode记录在头Page的FSP_SEG_INODES_FULL或者FSP_SEG_INODES_FREE字段。</span><br><span class="line">Inode Entry 0	192	Inode记录</span><br><span class="line">Inode Entry 1	 	 </span><br><span class="line">……	 	 </span><br><span class="line">Inode Entry 84</span><br></pre></td></tr></table></figure>
<p>每个Inode Entry的结构如下表所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Macro	bits	Desc</span><br><span class="line">FSEG_ID	8	该Inode归属的Segment ID，若值为0表示该slot未被使用</span><br><span class="line">FSEG_NOT_FULL_N_USED	8	FSEG_NOT_FULL链表上被使用的Page数量</span><br><span class="line">FSEG_FREE	16	完全没有被使用并分配给该Segment的Extent链表</span><br><span class="line">FSEG_NOT_FULL	16	至少有一个page分配给当前Segment的Extent链表，全部用完时，转移到FSEG_FULL上，全部释放时，则归还给当前表空间FSP_FREE链表</span><br><span class="line">FSEG_FULL	16	分配给当前segment且Page完全使用完的Extent链表</span><br><span class="line">FSEG_MAGIC_N	4	Magic Number</span><br><span class="line">FSEG_FRAG_ARR 0	4	属于该Segment的独立Page。总是先从全局分配独立的Page，当填满32个数组项时，就在每次分配时都分配一个完整的Extent，并在XDES PAGE中将其Segment ID设置为当前值</span><br><span class="line">……	……	 </span><br><span class="line">FSEG_FRAG_ARR 31	4	总共存储32个记录项</span><br></pre></td></tr></table></figure>

<p>offsets:16<em>1024</em>2=32768</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C -s 32768 -n 38 table5hang.ibd</span><br><span class="line">00008000  86 d5 41 60 00 00 00 02  00 00 00 00 00 00 00 00  |..A ............|</span><br><span class="line">00008010  00 00 00 00 80 eb 9d 23  00 03 00 00 00 00 00 00  |.......<span class="comment">#........|</span></span><br><span class="line">00008020  00 00 00 00 00 2c                                 |.....,|</span><br><span class="line">00008026</span><br><span class="line">(base)</span><br></pre></td></tr></table></figure>
<p>前 38也是  File Header<br>00 03 : 索引节点 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Macro	bits	Desc</span><br><span class="line">FSEG_INODE_PAGE_NODE	12	INODE页的链表节点，记录前后Inode Page的位置，BaseNode记录在头Page的FSP_SEG_INODES_FULL或者FSP_SEG_INODES_FREE字段。</span><br><span class="line">Inode Entry 0	192	Inode记录</span><br><span class="line">Inode Entry 1	 	 </span><br><span class="line">……	 	 </span><br><span class="line">Inode Entry 84</span><br></pre></td></tr></table></figure>
<p>每个Inode Entry的结构如下表所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Macro	bits	Desc</span><br><span class="line">FSEG_ID	8	该Inode归属的Segment ID，若值为0表示该slot未被使用</span><br><span class="line">FSEG_NOT_FULL_N_USED	8	FSEG_NOT_FULL链表上被使用的Page数量</span><br><span class="line">FSEG_FREE	16	完全没有被使用并分配给该Segment的Extent链表</span><br><span class="line">FSEG_NOT_FULL	16	至少有一个page分配给当前Segment的Extent链表，全部用完时，转移到FSEG_FULL上，全部释放时，则归还给当前表空间FSP_FREE链表</span><br><span class="line">FSEG_FULL	16	分配给当前segment且Page完全使用完的Extent链表</span><br><span class="line">FSEG_MAGIC_N	4	Magic Number</span><br><span class="line">FSEG_FRAG_ARR 0	4	属于该Segment的独立Page。总是先从全局分配独立的Page，当填满32个数组项时，就在每次分配时都分配一个完整的Extent，并在XDES PAGE中将其Segment ID设置为当前值</span><br><span class="line">……	……	 </span><br><span class="line">FSEG_FRAG_ARR 31	4	总共存储32个记录项</span><br></pre></td></tr></table></figure>


<h2 id="Index-索引页"><a href="#Index-索引页" class="headerlink" title="Index 索引页"></a>Index 索引页</h2><p>需要跳过3页面，即 49152，索引页 结构也符合基础页结构。</p>
<p><img src="/images/post/db-mysql/index-struct.webp" alt=""></p>
<p>同上述步骤类似</p>
<h3 id="FIL-Header（38字节-记录文件头信息。"><a href="#FIL-Header（38字节-记录文件头信息。" class="headerlink" title="FIL Header（38字节): 记录文件头信息。"></a>FIL Header（38字节): 记录文件头信息。</h3><p>offsets:16<em>1024</em>3=49152</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C -s 49152 -n 38 table5hang.ibd</span><br><span class="line">0000c000  3b 03 ff eb 00 00 00 03  ff ff ff ff ff ff ff ff  |;...............|</span><br><span class="line">0000c010  00 00 00 00 80 eb af c9  45 bf 00 00 00 00 00 00  |........E.......|</span><br><span class="line">0000c020  00 00 00 00 00 2c                                 |.....,|</span><br><span class="line">0000c026</span><br><span class="line">(base)</span><br></pre></td></tr></table></figure>
<p>前4字节 3b 03 ff eb 是 checksum，接着4个 00 00 00 03 是页偏移值 3，即这是第2+1页。【数组下标方式，这是真实的第四页】</p>
<p>接着 4 字节是上一页偏移值，ff ff ff ff 第一个数据页 无上一页，接着 4 字节是下一页偏移值 ff ff ff ff 无下一页。</p>
<p>然后 8 字节 00 00 00 00 80 eb af c9 是日志序列号 LSN。</p>
<p>随后的 2 字节 45 bf 是页类型，代表是 INDEX 页。</p>
<p>接着 8 字节 00 00 00 00 00 00 00 00 表示被更新到的LSN，在 File-Per-Table 表空间中都是0。</p>
<p>然后 4 字节 00 00 00 2c 表示该数据页属于的表t的表空间ID是 0x2c(44)。 与上文sql 查询一致</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_SYS_TABLES <span class="keyword">WHERE</span> <span class="keyword">NAME</span>=<span class="string">'test_innodb/table5hang'</span></span><br></pre></td></tr></table></figure>

<h3 id="PageHeader-INDEX-Header（56字节-记录的是-INDEX-页的状态信息"><a href="#PageHeader-INDEX-Header（56字节-记录的是-INDEX-页的状态信息" class="headerlink" title="PageHeader-INDEX Header（56字节): 记录的是 INDEX 页的状态信息"></a>PageHeader-INDEX Header（56字节): 记录的是 INDEX 页的状态信息</h3><p>offsets:16<em>1024</em>3+38=49190</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C -s 49190 -n 56 table5hang.ibd</span><br><span class="line">0000c026  00 02 01 36 80 07 00 00  00 00 01 17 00 02 00 04  |...6............|</span><br><span class="line">0000c036  00 05 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">0000c046  00 00 00 3c 00 00 00 2c  00 00 00 02 00 f2 00 00  |...&lt;...,........|</span><br><span class="line">0000c056  00 2c 00 00 00 02 00 32                           |.,.....2|</span><br><span class="line">0000c05e</span><br><span class="line">(base)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">名称	大小（Bytes）	描述</span><br><span class="line">PAGE_N_DIR_SLOTS	2	00 02：在Page Directory中Slot的数量，初始值为2</span><br><span class="line">PAGE_HEAP_TOP	    2	01 36：堆中第一个记录的指针,记录在页中是根据堆的形式存放</span><br><span class="line">PAGE_N_HEAP	        2	80 07：堆中的记录数，初始值为2，但是第15位表示行记录格式</span><br><span class="line">PAGE_FREE	        2	00 00：指向可重用空间的首指针</span><br><span class="line">PAGE_GARBAGE	    2	00 00：已标记为删除（deleted_flag）的记录的字节数</span><br><span class="line">PAGE_LAST_INSERT	2	01 17：最后插入记录的位置</span><br><span class="line">PAGE_DIRECTION	    2	00 02：最后插入的方向，PAGE_LEFT(0x01)，PAGE_RIGHT(0x02)，PAGE_SAME_REC(0X03),PAGE_SAME_PAGE(0X04),PAGE_NO_DIRECTION(0x05)</span><br><span class="line">PAGE_N_DIRECTION	2	00 04：一个方向上连续插入记录的数量</span><br><span class="line">PAGE_N_RECS	        2	00 05：该页中记录（User Record）的数量</span><br><span class="line">PAGE_MAX_TRX_ID	    8	00 00 00 00 00 00  00 00：修改该页的最大事务ID（仅在辅助索引中定义）</span><br><span class="line">PAGE_LEVEL	        2	00 00：该页在索引树中位置，0000代表叶子节点</span><br><span class="line">PAGE_INDEX_ID	    8	00 00 00 00 00 00 00 3c：索引ID，表示该页属于哪个索引</span><br><span class="line">PAGE_BTR_SEG_LEAF	10	00 00 00 2c 00 00 00 02 00 f2：B+Tree叶子节点所在Leaf Node Segment的Segment Header（无关紧要）</span><br><span class="line">PAGE_BTR_SEG_TOP	10	00 00 00 2c 00 00 00 02 00 32：B+Tree非叶子节点所在Non-Leaf Node Segment的Segment Header（无关紧要）</span><br></pre></td></tr></table></figure>
<p>PAGE_INDEX_ID = 3c =3*16+12=60  索引ID可以在information_schema.INNODB_SYS_INDEXES 中查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> information_schema.INNODB_SYS_INDEXES </span><br><span class="line"><span class="keyword">where</span> TABLE_ID <span class="keyword">in</span> (<span class="keyword">SELECT</span> TABLE_ID <span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_SYS_TABLES <span class="keyword">WHERE</span> <span class="keyword">NAME</span>=<span class="string">'test_innodb/table5hang'</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">index_id    name    table_id    type    n_fields    page_no space</span><br><span class="line">60          PRIMARY 58          3       1           3       44</span><br></pre></td></tr></table></figure>

<p>PAGE_BTR_SEG_LEAF和PAGE_BTR_SEG_TOP INDEX页中的根结点才有的，非根结点的为0。<br>前10字节 00 00 00 2c 00 00 00 02 00 f2 是叶子结点所在段的segment header，分别记录了叶子结点的表空间ID 0x24，INODE页的页号 2 和 INODE项偏移 0xf2。<br>后10字节 00 00 00 2c 00 00 00 02 00 32 是非叶子结点所在段的segment header，偏移分别是0xf2 和 0x32，即INODE页的前2个Entry，文件段ID分别是1和2。<br>FSEG Header中存储了该 INDEX 页的INODE项，INODE项里面则记录了该页存储所在的文件段以及文件段页的使用情况。对于 File-Per-Table情况下，每个单独的表空间文件的 FSP_HDR 页负责管理页使用情况。</p>
<p><img src="/images/post/db-mysql/fseg.webp" alt=""></p>
<h3 id="System-Records-26字节-infimum和supermum-record"><a href="#System-Records-26字节-infimum和supermum-record" class="headerlink" title="System Records(26字节)-infimum和supermum record"></a>System Records(26字节)-infimum和supermum record</h3><p>offset:16<em>1024</em>3+38+56 = 49246</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C -s 49246 -n 60 table5hang.ibd</span><br><span class="line">0000c05e  01 00 02 00 1c 69 6e 66  69 6d 75 6d 00 06 00 0b  |.....infimum....|</span><br><span class="line">0000c06e  00 00 73 75 70 72 65 6d  75 6d 06 00 00 00 10 00  |..supremum......|</span><br><span class="line">0000c07e  26 80 00 00 00 00 00 00  01 00 00 00 00 74 d0 9e  |&amp;............t..|</span><br><span class="line">0000c08e  00 00 01 57 01 10 6e 61  6d 65 2d 31              |...W..name-1|</span><br><span class="line">0000c09a</span><br><span class="line">(base)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">01 00 02 00 1c 69 6e 66 69 6d 75 6d 00 |.....infimum....|</span><br><span class="line">06 00 0b 00 00 73 75 70 72 65 6d 75 6d |..supremum......|</span><br></pre></td></tr></table></figure>
<p>每个 INDEX 页都有两条虚拟记录 infimum 和 supremum，用于限定记录的边界，各占 13 个字节。<br>其中记录头的5个字节分别标识了拥有记录的数目和类型(拥有记录数目是即后面页目录部分的owned值，当前页目录只有两个槽，infimum拥有记录数只有它自己为1，<br>而supremum拥有我们插入的5条记录和它自己，故为6)、下一条记录的偏移 0x1c=28 向后【当前位置】偏移 28个，即位置是 0xC062+0x1c=0xc07e 的后一个 0xco7f，这就是我们实际数据记录开始位置。<br>后面8个字节为 infimum + 空值，supremum类似，只是它下一条记录偏移为0。</p>
<h3 id="User-Records-1"><a href="#User-Records-1" class="headerlink" title="User Records"></a>User Records</h3><p>offset:16<em>1024</em>3+38+56 +26 = 49272</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C -s 49272 -n 1000 table5hang.ibd</span><br><span class="line">0000c078  06 00 00 00 10 00 26 80  00 00 00 00 00 00 01 00  |......&amp;.........|</span><br><span class="line">0000c088  00 00 00 74 d0 9e 00 00  01 57 01 10 6e 61 6d 65  |...t.....W..name|</span><br><span class="line">0000c098  2d 31 80 00 00 01 06 00  00 00 18 00 26 80 00 00  |-1..........&amp;...|</span><br><span class="line">0000c0a8  00 00 00 00 02 00 00 00  00 74 d0 9e 00 00 01 57  |.........t.....W|</span><br><span class="line">0000c0b8  01 20 6e 61 6d 65 2d 32  80 00 00 02 06 00 00 00  |. name-2........|</span><br><span class="line">0000c0c8  20 00 26 80 00 00 00 00  00 00 03 00 00 00 00 74  | .&amp;............t|</span><br><span class="line">0000c0d8  d0 9e 00 00 01 57 01 30  6e 61 6d 65 2d 33 80 00  |.....W.0name-3..|</span><br><span class="line">0000c0e8  00 03 06 00 00 00 28 00  26 80 00 00 00 00 00 00  |......(.&amp;.......|</span><br><span class="line">0000c0f8  04 00 00 00 00 74 d0 9e  00 00 01 57 01 40 6e 61  |.....t.....W.@na|</span><br><span class="line">0000c108  6d 65 2d 34 80 00 00 04  06 00 00 00 30 ff 59 80  |me-4........0.Y.|</span><br><span class="line">0000c118  00 00 00 00 00 00 05 00  00 00 00 74 d0 9e 00 00  |...........t....|</span><br><span class="line">0000c128  01 57 01 50 6e 61 6d 65  2d 35 80 00 00 05 00 00  |.W.Pname-5......|</span><br><span class="line">0000c138  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">0000c458  00 00 00 00 00 00 00 00                           |........|</span><br><span class="line">0000c460</span><br><span class="line">(base)</span><br></pre></td></tr></table></figure>
<p>查看 行记录格式 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLE</span> <span class="keyword">STATUS</span> <span class="keyword">from</span> test_innodb <span class="keyword">like</span> <span class="string">'table5hang'</span></span><br><span class="line"><span class="comment">--- Compact</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">接下来是插入的记录。Compact 【变长字段长度列表 小于255 1字节，大于 255 2】</span><br><span class="line">06  1字节记录的是可变变量的长度06，因为我们记录中c的值是 name-5。</span><br><span class="line">00  1字节记录的是可为NULL的变量是否是NULL，这里不为 NULL，故为0。</span><br><span class="line">记录头：00 00 10 00 26</span><br><span class="line">    Compact行记录格式 头格式</span><br><span class="line">    00  </span><br><span class="line">    00 10 &#x3D; 10110</span><br><span class="line">    00 26 &#x3D; 下一记录相对位置</span><br><span class="line">    后面就是记录内容。第2条记录同理。这里的事务ID可以通过 select * from information_schema.innodb_trx 进行验证。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">第一行</span><br><span class="line">0000c078  06 00 00 00 10 00 26 80  00 00 00 00 00 00 01 00  |......&amp;.........|</span><br><span class="line">0000c088  00 00 00 74 d0 9e 00 00  01 57 01 10 6e 61 6d 65  |...t.....W..name|</span><br><span class="line">0000c098  2d 31 80 00 00 01 06 00  00 00 18 00 26 80 00 00  |-1..........&amp;...|</span><br><span class="line"></span><br><span class="line"> 06 00 00 00 10 00 26 # 列长+null标记+记录头</span><br><span class="line"> 80 00 00 00 00 00 00 01   # 主键值1  bigint</span><br><span class="line"> 00 00 00 00 74 d0    # 事务ID</span><br><span class="line"> 9e 00 00 01 57 01 10 # 回滚指针</span><br><span class="line"> 6e 61 6d 65 2d 31    # username的值 name-1  6个字节</span><br><span class="line"> 80 00 00 01          # 列 age &#x3D;1  int 4字节</span><br><span class="line"> </span><br><span class="line">第二行</span><br><span class="line">                            06 00  00 00 18 00 26 80 00 00  |-1..........&amp;...|</span><br><span class="line">0000c0a8  00 00 00 00 02 00 00 00  00 74 d0 9e 00 00 01 57  |.........t.....W|</span><br><span class="line">0000c0b8  01 20 6e 61 6d 65 2d 32  80 00 00 02 06 00 00 00  |. name-2........|</span><br><span class="line"></span><br><span class="line"> 06 00 00 00 18 00 26 # 第2条记录头</span><br><span class="line"> 80 00 00 00 00 00 00 02   # 主键值1  bigint</span><br><span class="line"> 00 00 00 00 74 d0    # 事务ID</span><br><span class="line"> 9e 00 00 01 57 01 20 # 回滚指针</span><br><span class="line"> 6e 61 6d 65 2d 32    # username的值 name-1  6个字节</span><br><span class="line"> 80 00 00 01          # 列 age &#x3D;1  int 4字节</span><br><span class="line">&#96;&#96;&#96;    </span><br><span class="line">![](&#x2F;images&#x2F;post&#x2F;db-mysql&#x2F;bptree.webp)</span><br><span class="line"></span><br><span class="line">### Page Directory(4字节)</span><br><span class="line"></span><br><span class="line">因为页目录的slot只有2个，每个slot占2字节，故页目录为 00 70 00 63 这4字节，存储的是相对于最初行的位置。</span><br><span class="line"></span><br><span class="line">其中 0xc063 正好是 infimum 记录的开始位置，而 0xc070 正好是 supremum 记录的开始位置。使用页目录进行二分查找，可以加速查询，详细见后面分析。</span><br><span class="line"></span><br><span class="line">offset:16*1024*4 - 4 - 8 &#x3D; 65524</span><br><span class="line">&#96;&#96;&#96;bash</span><br><span class="line">hexdump -C -s 65524 -n 4 table5hang.ibd</span><br><span class="line">0000fff4  00 70 00 63                                       |.p.c|</span><br><span class="line">0000fff8</span><br><span class="line">(base)</span><br></pre></td></tr></table></figure>
<h3 id="FIL-Tail-8字节"><a href="#FIL-Tail-8字节" class="headerlink" title="FIL Tail (8字节)"></a>FIL Tail (8字节)</h3><p>offset:16<em>1024</em>4 - 8 = 65528</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C -s 65528 -n 8 table5hang.ibd</span><br><span class="line">0000fff8  bd 11 4b e6 80 eb af c9                           |..K.....|</span><br><span class="line">00010000</span><br><span class="line">(base)</span><br></pre></td></tr></table></figure>
<p>其中 bd 11 4b e6 为 checknum，跟 FIL Header的checksum一样。【没有匹配上，需要继续查看资料】</p>
<p>后4字节80 eb af c9 与 FIL Header的LSN的后4个字节一致。</p>
<h2 id="通过-innodb-ruby-工具来分析表空间文件"><a href="#通过-innodb-ruby-工具来分析表空间文件" class="headerlink" title="通过 innodb_ruby 工具来分析表空间文件"></a>通过 innodb_ruby 工具来分析表空间文件</h2><p>mac安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">brew install ruby</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/rubygems/rubygems.git</span><br><span class="line"><span class="built_in">cd</span> rubygems/bin/</span><br><span class="line">./gem install innodb_ruby</span><br><span class="line">``` </span><br><span class="line">``` bash</span><br><span class="line">innodb_space -s /Users/lihongxu6/docker/mymysql56/data/ibdata1 -T test_innodb/table5hang space-page-type-regions</span><br><span class="line">start       end         count       <span class="built_in">type</span>                </span><br><span class="line">0           0           1           FSP_HDR             </span><br><span class="line">1           1           1           IBUF_BITMAP         </span><br><span class="line">2           2           1           INODE               </span><br><span class="line">3           3           1           INDEX               </span><br><span class="line">4           5           2           FREE (ALLOCATED)    </span><br><span class="line">(base)</span><br></pre></td></tr></table></figure>
<p>查看具体数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">innodb_space -s /Users/lihongxu6/docker/mymysql56/data/ibdata1 -T test_innodb/table5hang -p 3 page-records</span><br><span class="line"><span class="comment"># Record 127: (id=1) → (username="name-1", age=1)</span></span><br><span class="line"><span class="comment"># Record 165: (id=2) → (username="name-2", age=2)</span></span><br><span class="line"><span class="comment"># Record 203: (id=3) → (username="name-3", age=3)</span></span><br><span class="line"><span class="comment"># Record 241: (id=4) → (username="name-4", age=4)</span></span><br><span class="line"><span class="comment"># Record 279: (id=5) → (username="name-5", age=5)</span></span><br><span class="line">(base)</span><br></pre></td></tr></table></figure>

<h2 id="其他-XDES页"><a href="#其他-XDES页" class="headerlink" title="其他-XDES页"></a>其他-XDES页</h2><p>簇或者分区（extent）是段的组成元素，在文件头使用FLAG描述了创建表信息，除此之外其他部分的数据结构和XDES PAGE都是相同的，<br>使用连续数组的方式，每个XDES PAGE最多存储256个XDES Entry，每个Entry占用40个字节，描述64个Page（即一个Extent）。格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Macro	bytes	Desc</span><br><span class="line">XDES_ID	8	如果该Extent归属某个segment的话，则记录其ID</span><br><span class="line">XDES_FLST_NODE	12(FLST_NODE_SIZE)	维持Extent链表的双向指针节点</span><br><span class="line">XDES_STATE	4	该Extent的状态信息，包括：XDES_FREE，XDES_FREE_FRAG，XDES_FULL_FRAG，XDES_FSEG，详解见下文</span><br><span class="line">XDES_BITMAP	16	总共16*8&#x3D; 128个bit，用2个bit表示Extent中的一个page，一个bit表示该page是否是空闲的(XDES_FREE_BIT)，另一个保留位，尚未使用（XDES_CLEAN_BIT）</span><br></pre></td></tr></table></figure>
<p>XDES_STATE表示该Extent的四种不同状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Macro	Desc</span><br><span class="line">XDES_FREE(1)	存在于FREE链表上</span><br><span class="line">XDES_FREE_FRAG(2)	存在于FREE_FRAG链表上</span><br><span class="line">XDES_FULL_FRAG(3)	存在于FULL_FRAG链表上</span><br><span class="line">XDES_FSEG(4)	该Extent归属于ID为XDES_ID记录的值的SEGMENT。</span><br></pre></td></tr></table></figure>
<p>通过XDES_STATE信息，我们只需要一个FLIST_NODE节点就可以维护每个Extent的信息，是处于全局表空间的链表上，还是某个btree segment的链表上。</p>
<h2 id="文件维护"><a href="#文件维护" class="headerlink" title="文件维护"></a>文件维护</h2><p>从上文我们可以看到，InnoDB通过Inode Entry来管理每个Segment占用的数据页，每个segment可以看做一个文件页维护单元。Inode Entry所在的inode page有可能存放满，因此又通过头Page维护了Inode Page链表。</p>
<p>在ibd的第一个Page中还维护了表空间内Extent的FREE、FREE_FRAG、FULL_FRAG三个Extent链表；而每个Inode Entry也维护了对应的FREE、NOT_FULL、FULL三个Extent链表。这些链表之间存在着转换关系，以高效的利用数据文件空间。</p>
<p>注意区别：表空间中的链表管理的是整个表空间中所有的簇，包括满簇、半满簇及空闲簇，而段的iNode信息中管理的是属于自己段中的满簇、半满簇及空闲簇。</p>
<p>当创建一个新的索引时，实际上构建一个新的btree(btr_create)，先为非叶子节点Segment分配一个inode entry，再创建root page，并将该segment的位置记录到root page中，然后再分配leaf segment的Inode entry，并记录到root page中。当删除某个索引后，该索引占用的空间需要能被重新利用起来。</p>
<p>创建一个segment：</p>
<p>函数入口：fseg_create_general。</p>
<ol>
<li><p>根据空间id得到表空间头信息。</p>
</li>
<li><p>从得到的表空间头信息分配Inode:具体实现为读取文件头Page并加锁（fsp_get_space_header），然后开始为其分配Inode Entry(fsp_alloc_seg_inode)。</p>
<p> 为了管理Inode Page，在文件头存储了两个Inode Page链表，一个链接已经用满的inode page，一个链接尚未用满的inode page。如果当前Inode Page的空间使用完了，<br> 就需要再分配一个inode page，并加入到FSP_SEG_INODES_FREE链表上(fsp_alloc_seg_inode_page)。对于独立表空间，通常一个inode page就足够了。</p>
</li>
</ol>
<p>具体查找inode Page过程：首先判断FSP_SEG_INODES_FREE链表是否还有空闲页面，如果有，则从页面的数据存储位置开始扫描，没找一个Inode，先判断是否空闲（空闲表示其不归属任何segment，即FSEG_ID置为0）。<br>找到则返回。找到这个且这个Inode为这个页最后一个Inode.则该inode page中的记录用满了，就从FSP_SEG_INODES_FREE链表上转移到FSP_SEG_INODES_FULL链表。<br>如果FSP_SEG_INODES_FREE没有空闲的Inode页面，则重新分配一个inode页面，分配后把所有描述符里面的FSEG_ID置为0，重复上面过程。</p>
<ol start="3">
<li><p>给新分配的Inode设置SEG_ID. 这个ID号要从表空间头信息的FSP_SEG_ID作为当前segment的seg id写入到inode entry中。同时更新FSP_SEG_ID的值为ID+1，作为下一个段的ID号。</p>
</li>
<li><p>在完成inode entry的提取后，初始化这个Inode信息。把FSEG_NOT_FULL_N_USED置为0，初始化FSEG_FREE、FSEG_NOT_FULL，FSEG_FULL。</p>
</li>
<li><p>从这个段分配出一个页面。（这块逻辑不太懂）</p>
</li>
<li><p>分配好页面后，通过缓存找到段的首页面（页面号为page+index）。就将该inode entry所在inode page的位置及页内偏移量存储到段首页，10个字节的inode信息包括：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Macro	bytes	Desc</span><br><span class="line">FSEG_HDR_SPACE	4	描述该segment的inode page所在的space id （目前的实现来看，感觉有点多余…）</span><br><span class="line">FSEG_HDR_PAGE_NO	4	描述该segment的inode page的page no</span><br><span class="line">FSEG_HDR_OFFSET	2	inode page内的页内偏移量</span><br></pre></td></tr></table></figure>
<p>至此段就分配完成了，以后如果需要在这个段中分配空间，只需要找到其首页，然后根据对应的Inode分配空间。</p>
</li>
</ol>
<p>分配数据页函数 fsp_alloc_free_page</p>
<p>表空间Extent的分配函数fsp_alloc_free_extent。</p>
<p>对应的还有释放Segment 当我们删除索引或者表时，需要删除btree（btr_free_if_exists），先删除除了root节点外的其他部分(btr_free_but_not_root)，再删除root节点(btr_free_root)</p>
<p>由于数据操作都需要记录redo，为了避免产生非常大的redo log，leaf segment通过反复调用函数fseg_free_step来释放其占用的数据页。</p>
<h2 id="创建B-索引"><a href="#创建B-索引" class="headerlink" title="创建B+索引"></a>创建B+索引</h2><p>innodb的文件管理方式，核心目的是为了管理好B+索引。</p>
<p>ibd文件中真正构建起用户数据的结构是BTREE，在你创建一个表时，已经基于显式或隐式定义的主键构建了一个btree，其叶子节点上记录了行的全部列数据（加上事务id列及回滚段指针列）；</p>
<p>如果你在表上创建了二级索引，其叶子节点存储了键值加上聚集索引键值。所以书上贴一段创建B+索引的代码。网上找了5.6.15版本的。</p>
<p>这个函数就是创建一个B+树，只是概念上的，还没有真正的数据写入。</p>
<h1 id="页内-页目录"><a href="#页内-页目录" class="headerlink" title="页内-页目录"></a>页内-页目录</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t2(<span class="keyword">id</span> <span class="built_in">int</span> auto_increment primary <span class="keyword">key</span>, ch <span class="built_in">varchar</span>(<span class="number">10</span>), <span class="keyword">key</span>(ch));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t2(ch) <span class="keyword">values</span>(<span class="string">'ab'</span>);</span><br></pre></td></tr></table></figure>
<p>创建一个新的测试表 t2，有主索引 id 和 辅助索引 ch，分析 t2.ibd 文件可验证：</p>
<ul>
<li>对比没有辅助索引的表，表t2多一个INDEX页，用于存储辅助索引的根结点。</li>
<li>辅助索引的INDEX页也有两个系统记录 infimum 和 supremum。而用户记录内容格式跟前面分析基本一致，内容为辅助索引 ch 列的值 ab 和 主键值1。</li>
</ul>
<p>INDEX页内的记录是通过单向链表连接在一起的，遍历列表性能会比较差，而INDEX页的页目录就是为了加速记录搜索。</p>
<p>表 t2 中的页目录只有两项，分别是 0x63 和 0x70，即 99 和 112。</p>
<p>下面的ownedkey为这个页目录槽拥有的小于等于它的记录数目，显然 infimum 的ownedkey为 1，即只有它自己，没有key会比infimum小。</p>
<p>而 supremum 的owned是3，分别是我们插入的两条记录和它自己。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">slot    offset  type          owned  key</span><br><span class="line">0       99      infimum       1       </span><br><span class="line">1       112     supremum      3</span><br></pre></td></tr></table></figure>
<p>每个页目录槽最少要包含4个记录，最多包含8个记录(包括它自己)。如果我们在表 t2 中另外插入 7 条记录，则会增加一个新的slot，即 id 为 4 的记录，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">slot    offset  type          owned   key</span><br><span class="line">0       99      infimum       1       </span><br><span class="line">1       207     conventional  4       (i&#x3D;4)</span><br><span class="line">2       112     supremum      5</span><br></pre></td></tr></table></figure>
<p>下图是页目录结构图，可以通过页目录的二分查找提高页内数据的查询性能。</p>
<p><img src="/images/post/db-mysql/bptreepagestruct.webp" alt=""></p>
<p>参考：</p>
<p><a href="http://mysql.taobao.org/monthly/2016/02/01/" target="_blank" rel="noopener">http://mysql.taobao.org/monthly/2016/02/01/</a></p>
<p>《MYSQL运维内参》<a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-file-space.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/innodb-file-space.html</a></p>
<p>链接：<a href="https://blog.csdn.net/bohu83/article/details/81086474" target="_blank" rel="noopener">https://blog.csdn.net/bohu83/article/details/81086474</a><br><a href="http://mysql.taobao.org/monthly/2016/02/01/" target="_blank" rel="noopener">http://mysql.taobao.org/monthly/2016/02/01/</a></p>

    </div>

    
    
    
        <div class="reward-container">
  <div>一分也是爱，两分情更浓【还没有人赞赏，支持一下呗】</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/reward/bjlhx-wx.bmp" alt="李宏旭 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/reward/bjlhx-zfb.bmp" alt="李宏旭 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>李宏旭
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://blog.bjlhx.top/articles/20200202/12fe7f8a.html" title="06-存储引擎层-innodb框架-表空间-段、区、页与组织结构">https://blog.bjlhx.top/articles/20200202/12fe7f8a.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/articles/20200202/20b74871.html" rel="prev" title="05-存储引擎层-innodb框架-表空间-ibd">
      <i class="fa fa-chevron-left"></i> 05-存储引擎层-innodb框架-表空间-ibd
    </a></div>
      <div class="post-nav-item">
    <a href="/articles/20200203/d189e05e.html" rel="next" title="001-shell-概述与命令行区别">
      001-shell-概述与命令行区别 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-utteranc">评论[utteranc,基于github]</a></li>
            <li class="tab"><a href="#comment-livere">评论[来必力,三方]</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane utteranc" id="comment-utteranc">
              
  
  <div class="comments">
  <script src="https://utteranc.es/client.js" repo="bjlhx15/gitment-issues.bjlhx15.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script>
  </div>
  
  
            </div>
            <div class="tab-pane livere" id="comment-livere">
              
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC80ODQzNS8yNDkyOQ=="></div>
  </div>
  
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#表空间物理结构-页、区、段"><span class="nav-number">1.</span> <span class="nav-text">表空间物理结构-页、区、段</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#段（segment）"><span class="nav-number">1.1.</span> <span class="nav-text">段（segment）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#区-簇（extents）"><span class="nav-number">1.2.</span> <span class="nav-text">区&#x2F;簇（extents）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#页（page）"><span class="nav-number">1.3.</span> <span class="nav-text">页（page）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#页存储单元"><span class="nav-number">1.3.1.</span> <span class="nav-text">页存储单元</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#页结构"><span class="nav-number">1.3.2.</span> <span class="nav-text">页结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#File-Header-记录页的一些头信息，共占用38字节，组成部分如"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">File Header 记录页的一些头信息，共占用38字节，组成部分如:</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#页类型【innodb存储引擎中】"><span class="nav-number">1.3.2.1.1.</span> <span class="nav-text">页类型【innodb存储引擎中】</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Page-Header：记录数据页的状态信息，共占56个字节，组成部分如图："><span class="nav-number">1.3.2.2.</span> <span class="nav-text">Page Header：记录数据页的状态信息，共占56个字节，组成部分如图：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#infimum和supermum-record"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">infimum和supermum record</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#User-Records"><span class="nav-number">1.3.2.4.</span> <span class="nav-text">User Records</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Free-Space"><span class="nav-number">1.3.2.5.</span> <span class="nav-text">Free Space</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Page-Directory"><span class="nav-number">1.3.2.6.</span> <span class="nav-text">Page Directory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#File-Trailer"><span class="nav-number">1.3.2.7.</span> <span class="nav-text">File Trailer</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结"><span class="nav-number">1.4.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#表空间ibd与页关系"><span class="nav-number">2.</span> <span class="nav-text">表空间ibd与页关系</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ibd文件存储结构【页】"><span class="nav-number">2.1.</span> <span class="nav-text">ibd文件存储结构【页】</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#表空间文件ibd-页类型-实操说明"><span class="nav-number">3.</span> <span class="nav-text">表空间文件ibd-页类型-实操说明</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#FSP-HDR-PAGE【File-Space-Header-Page】"><span class="nav-number">3.1.</span> <span class="nav-text">FSP_HDR PAGE【File Space Header Page】</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IBUF-BITMAP-Page"><span class="nav-number">3.2.</span> <span class="nav-text">IBUF_BITMAP Page</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FIL-PAGE-INODE"><span class="nav-number">3.3.</span> <span class="nav-text">FIL_PAGE_INODE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Index-索引页"><span class="nav-number">3.4.</span> <span class="nav-text">Index 索引页</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#FIL-Header（38字节-记录文件头信息。"><span class="nav-number">3.4.1.</span> <span class="nav-text">FIL Header（38字节): 记录文件头信息。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PageHeader-INDEX-Header（56字节-记录的是-INDEX-页的状态信息"><span class="nav-number">3.4.2.</span> <span class="nav-text">PageHeader-INDEX Header（56字节): 记录的是 INDEX 页的状态信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#System-Records-26字节-infimum和supermum-record"><span class="nav-number">3.4.3.</span> <span class="nav-text">System Records(26字节)-infimum和supermum record</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#User-Records-1"><span class="nav-number">3.4.4.</span> <span class="nav-text">User Records</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FIL-Tail-8字节"><span class="nav-number">3.4.5.</span> <span class="nav-text">FIL Tail (8字节)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通过-innodb-ruby-工具来分析表空间文件"><span class="nav-number">3.5.</span> <span class="nav-text">通过 innodb_ruby 工具来分析表空间文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他-XDES页"><span class="nav-number">3.6.</span> <span class="nav-text">其他-XDES页</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文件维护"><span class="nav-number">3.7.</span> <span class="nav-text">文件维护</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建B-索引"><span class="nav-number">3.8.</span> <span class="nav-text">创建B+索引</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#页内-页目录"><span class="nav-number">4.</span> <span class="nav-text">页内-页目录</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="李宏旭"
      src="/images/about/kenan.jpeg">
  <p class="site-author-name" itemprop="name">李宏旭</p>
  <div class="site-description" itemprop="description">学习 总结 分享</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/bjlhx15" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;bjlhx15" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://bjlhx.cnblogs.com/" title="Cnblog → https:&#x2F;&#x2F;bjlhx.cnblogs.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>Cnblog</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李宏旭</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>

</body>
</html>
